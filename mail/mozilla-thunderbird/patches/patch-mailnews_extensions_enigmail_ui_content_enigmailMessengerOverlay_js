$OpenBSD$
upstream fixes from enigmail CVS
https://www.mozdev.org/bugs/show_bug.cgi?id=24577
https://www.mozdev.org/bugs/show_bug.cgi?id=24568
https://www.mozdev.org/bugs/show_bug.cgi?id=24557

--- mailnews/extensions/enigmail/ui/content/enigmailMessengerOverlay.js.orig	Fri Oct 21 07:29:37 2011
+++ mailnews/extensions/enigmail/ui/content/enigmailMessengerOverlay.js	Tue Nov 22 17:55:29 2011
@@ -81,6 +81,7 @@ Enigmail.msg = {
         if (element) {
           try {
             var oldValue = element.getAttribute(attrName);
+            EnigmailCommon.DEBUG_LOG("enigmailMessengerOverlay.js: overrideAttribute "+attrName+": oldValue="+oldValue+"\n");
             var newValue = prefix+elementId+suffix;
 
             element.setAttribute(attrName, newValue);
@@ -527,16 +528,19 @@ Enigmail.msg = {
   {
     EnigmailCommon.DEBUG_LOG("enumerateMimeParts: "+mimePart.partName+" - "+mimePart.headers["content-type"]+"\n");
 
-    // does not work properly because MsgHdrToMimeMessage() cannot [yet] handle inner parts of encrypted messages
-
-    var ct = mimePart.headers["content-type"][0];
-    if (typeof(ct) == "string") {
-      if (ct.search(/multipart\/signed.*application\/pgp-signature/i) >= 0) {
-        resultObj.signed=mimePart.partName;
+    try {
+      var ct = mimePart.headers["content-type"][0];
+      if (typeof(ct) == "string") {
+        if (ct.search(/multipart\/signed.*application\/pgp-signature/i) >= 0) {
+          resultObj.signed=mimePart.partName;
+        }
+        else if (ct.search(/application\/pgp-encrypted/i) >= 0)
+          resultObj.encrypted=mimePart.partName;
       }
-      else if (ct.search(/application\/pgp-encrypted/i) >= 0)
-        resultObj.encrypted=mimePart.partName;
     }
+    catch (ex) {
+      // catch exception if no headers or no content-type defined.
+    }
 
     var i;
     for (i in mimePart.parts) {
@@ -1685,9 +1689,15 @@ Enigmail.msg = {
   {
     EnigmailCommon.DEBUG_LOG("enigmailMessengerOverlay.js: handleAttachmentSel: actionType="+actionType+"\n");
 
-    var contextMenu = document.getElementById('attachmentListContext');
+    // Thunderbird
+    var contextMenu = document.getElementById('attachmentItemContext');
     var selectedAttachments = contextMenu.attachments;
 
+    if (! contextMenu) {
+      // SeaMonkey
+      contextMenu = document.getElementById('attachmentListContext');
+      selectedAttachments = attachmentList.selectedItems;
+    }
     var anAttachment = selectedAttachments[0];
 
     switch (actionType) {
