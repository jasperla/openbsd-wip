# $OpenBSD$

CATEGORIES=	sysutils
COMMENT=	Device Tree Blobs
DISTNAME=	linux-4.5
PKGNAME=	${DISTNAME:S/linux/dtb/}
EXTRACT_SUFX=	.tar.xz
MASTER_SITES=	https://cdn.kernel.org/pub/linux/kernel/v4.x/
HOMEPAGE=	http://www.devicetree.org

BUILD_DEPENDS=	devel/dtc \
		lang/gcc/4.9

# dual GPL/BSD
PERMIT_PACKAGE_CDROM=	Yes

ARCHS= arm arm64 mips powerpc

do-build:
.for ARCH in ${ARCHS}
	cd ${WRKSRC}/arch/${ARCH}/boot/dts ; \
        for vendor in `find . -type d ! -name include` ; do \
	    cd ${WRKSRC}/arch/${ARCH}/boot/dts/$$vendor ; \
	    for dts in `ls *.dts` ; do \
	        ecpp -nostdinc -I . -I include -I${WRKSRC}/include -undef -D__DTS__ \
	            -x assembler-with-cpp $$dts | dtc -I dts -O dtb -o \
	            `echo "$$dts" | sed -e 's/\.dts$$/\.dtb/'` - ; \
	    done ; \
	done
.endfor

do-install:
	${INSTALL_DATA_DIR} ${PREFIX}/share/dtb
.for ARCH in ${ARCHS}
	${INSTALL_DATA_DIR} ${PREFIX}/share/dtb/${ARCH}
	cd ${WRKSRC}/arch/${ARCH}/boot/dts ; \
	for vendor in `find . -type d ! -name include` ; do \
	    ${INSTALL_DATA_DIR} ${PREFIX}/share/dtb/${ARCH}/$$vendor ; \
	    cd ${WRKSRC}/arch/${ARCH}/boot/dts/$$vendor ; \
	    for dtb in `ls *.dtb` ; do \
		${INSTALL_DATA} ${WRKSRC}/arch/${ARCH}/boot/dts/$$vendor/$$dtb \
		    ${PREFIX}/share/dtb/${ARCH}/$$vendor ; \
	    done ; \
	done
.endfor

.include <bsd.port.mk>
